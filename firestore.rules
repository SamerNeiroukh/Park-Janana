rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ✅ Keep existing users collection rules
    match /users/{userId} {
      allow read, write: if request.auth != null;
    }

    // ✅ Keep existing shifts collection rules
    match /shifts/{shiftId} {
  // Allow authenticated users to read shift data
  allow read: if request.auth != null;

  // Allow authenticated users to create or delete shifts
  allow create, delete: if request.auth != null;

  // Allow authenticated users to update any of the following fields
  allow update: if request.auth != null &&
    request.resource.data.keys().hasAny([
      "date",
      "department",
      "startTime",
      "endTime",
      "maxWorkers",
      "requestedWorkers",
      "assignedWorkers",
      "messages",
      "createdBy",
      "createdAt",
      "lastUpdatedBy",
      "lastUpdatedAt",
      "status",
      "cancelReason",
      "assignedWorkerData",
      "shiftManager"
    ]);
}

   match /tasks/{taskId} {
  allow read: if request.auth != null;

  // Full write access for managers & owners
  allow write: if request.auth != null &&
    exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
    get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ["manager", "owner"];

  // Allow worker to update only their workerProgress and status field
  allow update: if request.auth != null &&
    resource.data.assignedTo.hasAny([request.auth.uid]) &&
    request.writeFields.hasOnly([
      "workerProgress." + request.auth.uid,
      "status"
    ]);
}


    match /attendance_logs/{logId} {
  allow read: if request.auth != null &&
    logId.split('_')[0] == request.auth.uid;

  allow create: if request.auth != null &&
    request.resource.data.userId == request.auth.uid;

  allow update: if request.auth != null &&
    resource.data.userId == request.auth.uid;
}



  }
}
